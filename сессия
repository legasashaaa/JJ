from telethon import TelegramClient
from telethon.sessions import StringSession
import asyncio
import os

async def create_and_save_session():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª"""
    
    # –ü–æ–ª—É—á–∏—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ https://my.telegram.org
    API_ID = 1234567  # –í–∞—à API ID
    API_HASH = '–≤–∞—à_api_hash'  # –í–∞—à API Hash
    
    # –ò–º—è –¥–ª—è —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏
    session_name = input("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏ (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è): ").strip()
    if not session_name:
        session_name = "my_session"
    
    print(f"\n–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏...")
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–µ–π –≤ –ø–∞–º—è—Ç–∏
    temp_session = StringSession()
    client = TelegramClient(temp_session, API_ID, API_HASH)
    
    await client.connect()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if not await client.is_user_authorized():
        print("–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...")
        
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        phone = input("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä +79991234567): ").strip()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–æ–¥
        await client.send_code_request(phone)
        print("–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!")
        
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–¥
        code = input("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–æ–¥: ").strip()
        
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏ —Å –∫–æ–¥–æ–º
            await client.sign_in(phone=phone, code=code)
        except Exception as e:
            # –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å (2FA)
            if "password" in str(e).lower():
                print("–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.")
                password = input("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA: ")
                await client.sign_in(password=password)
            else:
                raise e
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
    me = await client.get_me()
    print(f"\n‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!")
    print(f"–ò–º—è: {me.first_name}")
    print(f"–§–∞–º–∏–ª–∏—è: {me.last_name or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}")
    print(f"Username: @{me.username or '–ù–µ —É–∫–∞–∑–∞–Ω'}")
    print(f"ID: {me.id}")
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å–µ—Å—Å–∏–∏
    session_string = client.session.save()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É —Å–µ—Å—Å–∏–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
    with open(f"{session_name}_string.txt", "w", encoding="utf-8") as f:
        f.write(session_string)
    
    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª–æ–≤—É—é —Å–µ—Å—Å–∏—é –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    file_client = TelegramClient(f"{session_name}.session", API_ID, API_HASH)
    await file_client.connect()
    file_client.session = StringSession(session_string)
    await file_client.session.save()  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª .session
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    print("\nüîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...")
    async for dialog in client.iter_dialogs(limit=3):
        print(f"  - {dialog.name} ({dialog.id})")
    
    await file_client.disconnect()
    await client.disconnect()
    
    print(f"\nüìÅ –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Ñ–∞–π–ª—ã:")
    print(f"1. {session_name}.session (–±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª —Å–µ—Å—Å–∏–∏)")
    print(f"2. {session_name}_string.txt (—Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ)")
    print(f"\nüìã –°—Ç—Ä–æ–∫–∞ —Å–µ—Å—Å–∏–∏ (–ø–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤):")
    print(f"{session_string[:100]}...")

async def load_session_from_file():
    """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞"""
    
    API_ID = 1234567
    API_HASH = '–≤–∞—à_api_hash'
    
    # –ò—â–µ–º —Ñ–∞–π–ª—ã .session
    session_files = [f for f in os.listdir('.') if f.endswith('.session')]
    
    if not session_files:
        print("–§–∞–π–ª—ã —Å–µ—Å—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!")
        return None
    
    print("\n–ù–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã —Å–µ—Å—Å–∏–π:")
    for i, file in enumerate(session_files, 1):
        print(f"{i}. {file}")
    
    choice = input(f"\n–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª (1-{len(session_files)}): ").strip()
    
    try:
        idx = int(choice) - 1
        session_file = session_files[idx]
    except (ValueError, IndexError):
        session_file = input("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏: ").strip()
        if not session_file.endswith('.session'):
            session_file += '.session'
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Å—Å–∏—é
    client = TelegramClient(session_file, API_ID, API_HASH)
    await client.connect()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if await client.is_user_authorized():
        me = await client.get_me()
        print(f"\n‚úÖ –°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
        print(f"–ê–∫–∫–∞—É–Ω—Ç: {me.first_name} (@{me.username})")
        return client
    else:
        print("‚ùå –°–µ—Å—Å–∏—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞!")
        await client.disconnect()
        return None

async def load_session_from_string():
    """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ –∏–∑ —Å—Ç—Ä–æ–∫–∏"""
    
    API_ID = 1234567
    API_HASH = '–≤–∞—à_api_hash'
    
    # –ò—â–µ–º —Ñ–∞–π–ª—ã —Å —Å—Ç—Ä–æ–∫–∞–º–∏ —Å–µ—Å—Å–∏–π
    string_files = [f for f in os.listdir('.') if f.endswith('_string.txt')]
    
    if not string_files:
        print("–§–∞–π–ª—ã —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏ —Å–µ—Å—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!")
        return None
    
    print("\n–ù–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏ —Å–µ—Å—Å–∏–π:")
    for i, file in enumerate(string_files, 1):
        print(f"{i}. {file}")
    
    choice = input(f"\n–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª (1-{len(string_files)}): ").strip()
    
    try:
        idx = int(choice) - 1
        string_file = string_files[idx]
    except (ValueError, IndexError):
        string_file = input("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞: ").strip()
        if not string_file.endswith('_string.txt'):
            string_file += '_string.txt'
    
    # –ß–∏—Ç–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å–µ—Å—Å–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞
    try:
        with open(string_file, "r", encoding="utf-8") as f:
            session_string = f.read().strip()
    except FileNotFoundError:
        print(f"‚ùå –§–∞–π–ª {string_file} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return None
    
    if not session_string:
        print("‚ùå –§–∞–π–ª –ø—É—Å—Ç!")
        return None
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ —Å —Å—Ç—Ä–æ–∫–æ–≤–æ–π —Å–µ—Å—Å–∏–µ–π
    session = StringSession(session_string)
    client = TelegramClient(session, API_ID, API_HASH)
    await client.connect()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if await client.is_user_authorized():
        me = await client.get_me()
        print(f"\n‚úÖ –°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏ —É—Å–ø–µ—à–Ω–æ!")
        print(f"–ê–∫–∫–∞—É–Ω—Ç: {me.first_name} (@{me.username})")
        return client
    else:
        print("‚ùå –°—Ç—Ä–æ–∫–∞ —Å–µ—Å—Å–∏–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞!")
        await client.disconnect()
        return None

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print("=" * 50)
    print("TELEGRAM SESSION MANAGER")
    print("=" * 50)
    
    while True:
        print("\n–ú–µ–Ω—é:")
        print("1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª")
        print("2. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é –∏–∑ —Ñ–∞–π–ª–∞ (.session)")
        print("3. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏—é –∏–∑ —Å—Ç—Ä–æ–∫–∏ (_string.txt)")
        print("4. –í—ã—Ö–æ–¥")
        
        choice = input("\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ (1-4): ").strip()
        
        if choice == '1':
            await create_and_save_session()
        elif choice == '2':
            client = await load_session_from_file()
            if client:
                await use_session_menu(client)
        elif choice == '3':
            client = await load_session_from_string()
            if client:
                await use_session_menu(client)
        elif choice == '4':
            print("–í—ã—Ö–æ–¥...")
            break
        else:
            print("–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä!")

async def use_session_menu(client):
    """–ú–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–µ–π"""
    try:
        while True:
            print("\n" + "=" * 30)
            print("–î–ï–ô–°–¢–í–ò–Ø –° –°–ï–°–°–ò–ï–ô")
            print("=" * 30)
            print("1. –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ")
            print("2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∏–∞–ª–æ–≥–∏")
            print("3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ")
            print("4. –ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Å–µ—Å—Å–∏–∏")
            print("5. –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
            
            action = input("\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: ").strip()
            
            if action == '1':
                me = await client.get_me()
                print(f"\nüìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ:")
                print(f"ID: {me.id}")
                print(f"–ò–º—è: {me.first_name}")
                print(f"–§–∞–º–∏–ª–∏—è: {me.last_name or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}")
                print(f"Username: @{me.username or '–ù–µ —É–∫–∞–∑–∞–Ω'}")
                print(f"–¢–µ–ª–µ—Ñ–æ–Ω: {me.phone or '–ù–µ —É–∫–∞–∑–∞–Ω'}")
            
            elif action == '2':
                limit = input("–°–∫–æ–ª—å–∫–æ –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ–∫–∞–∑–∞—Ç—å? (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10): ").strip()
                limit = int(limit) if limit.isdigit() else 10
                
                print(f"\nüì® –ü–æ—Å–ª–µ–¥–Ω–∏–µ {limit} –¥–∏–∞–ª–æ–≥–æ–≤:")
                count = 0
                async for dialog in client.iter_dialogs(limit=limit):
                    count += 1
                    print(f"{count}. {dialog.name} (ID: {dialog.id})")
            
            elif action == '3':
                phone_or_username = input("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, username –∏–ª–∏ ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è: ").strip()
                message = input("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ").strip()
                
                try:
                    await client.send_message(phone_or_username, message)
                    print("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
                except Exception as e:
                    print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
            
            elif action == '4':
                if isinstance(client.session, StringSession):
                    session_string = client.session.save()
                    print(f"\nüìã –°—Ç—Ä–æ–∫–∞ —Å–µ—Å—Å–∏–∏:")
                    print(f"{session_string}")
                    
                    save_choice = input("\n–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª? (y/n): ").strip().lower()
                    if save_choice == 'y':
                        filename = input("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è): ").strip()
                        if not filename:
                            filename = "session_backup"
                        
                        with open(f"{filename}_string.txt", "w", encoding="utf-8") as f:
                            f.write(session_string)
                        print(f"‚úÖ –°—Ç—Ä–æ–∫–∞ —Å–µ—Å—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ {filename}_string.txt")
                else:
                    print("‚ùå –≠—Ç–æ –Ω–µ —Å—Ç—Ä–æ–∫–æ–≤–∞—è —Å–µ—Å—Å–∏—è. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–µ—Å—Å–∏—é —á–µ—Ä–µ–∑ –ø—É–Ω–∫—Ç 1 –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é.")
            
            elif action == '5':
                print("–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é...")
                await client.disconnect()
                break
            
            else:
                print("–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä!")
    
    except Exception as e:
        print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
        await client.disconnect()

if __name__ == "__main__":
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ API –¥–∞–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
    if '–≤–∞—à_api_hash' in API_HASH or API_ID == 1234567:
        print("\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ API –¥–∞–Ω–Ω—ã–µ!")
        print("–ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ–ª—É—á–∏—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ https://my.telegram.org")
        print("–ò –∑–∞–º–µ–Ω–∏—Ç–µ API_ID –∏ API_HASH –≤ –∫–æ–¥–µ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 8 –∏ 9\n")
    
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n\n–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
    except Exception as e:
        print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
